
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.knada.io/dataprodukter/dele/dataoverf%C3%B8ring/">
      
      
        <link rel="prev" href="../f%C3%A5-tilgang/">
      
      
        <link rel="next" href="../../kvalitetssikring/">
      
      
      <link rel="icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Laste data fra kilde til BigQuery - NADA</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#flytte-data-fra-postgres-til-bigquery" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="NADA" class="md-header__button md-logo" aria-label="NADA" data-md-component="logo">
      
  <img src="../../../img/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            NADA
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Laste data fra kilde til BigQuery
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/navikt/nada" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="NADA" class="md-nav__button md-logo" aria-label="NADA" data-md-component="logo">
      
  <img src="../../../img/logo.svg" alt="logo">

    </a>
    NADA
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/navikt/nada" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Om NADA
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ordliste/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ordliste
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Juridisk
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Juridisk
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../juridisk/dokumentasjon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hva trenger jeg av dokumentasjon?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../juridisk/spilleregler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spilleregler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../juridisk/hvem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hvem lager spilleregler?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../juridisk/pvk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hvordan fyller jeg ut PVK?
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Dataprodukter
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Dataprodukter
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dataprodukt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hva er et dataprodukt?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kom i gang
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../f%C3%A5-tilgang/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Få tilgang til datakilder
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Laste data fra kilde til BigQuery
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Laste data fra kilde til BigQuery
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#flytte-data-fra-postgres-til-bigquery" class="md-nav__link">
    <span class="md-ellipsis">
      Flytte data fra Postgres til BigQuery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flytte data fra Postgres til BigQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#datastream" class="md-nav__link">
    <span class="md-ellipsis">
      Datastream
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Datastream">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hjelp-til-oppsett-av-datastream" class="md-nav__link">
    <span class="md-ellipsis">
      Hjelp til oppsett av Datastream
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#federated-query" class="md-nav__link">
    <span class="md-ellipsis">
      Federated query
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Federated query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kjre-sprring-pa-tidsintervall" class="md-nav__link">
    <span class="md-ellipsis">
      Kjøre spørring på tidsintervall
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flytte-data-fra-kafka-til-bigquery" class="md-nav__link">
    <span class="md-ellipsis">
      Flytte data fra Kafka til BigQuery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flytte data fra Kafka til BigQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kodeeksempler" class="md-nav__link">
    <span class="md-ellipsis">
      Kodeeksempler
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#naisjob" class="md-nav__link">
    <span class="md-ellipsis">
      Naisjob
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Naisjob">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bruksomrade" class="md-nav__link">
    <span class="md-ellipsis">
      Bruksområde
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kvalitetssikring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kvalitetssikre data (Soda)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dataprodukt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Legge til et dataprodukt
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tilgangsstyring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tilgangsstyring
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Analyse
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Analyse
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/kom-i-gang/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kom i gang
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Jupyter notebooks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Jupyter notebooks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/notebook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hva er Jupyter notebooks?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/notebook/knada-notebook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    KNADA notebooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/notebook/managed-notebook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google managed notebooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/notebook/generelt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Generelle råd
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Airflow
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Airflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/airflow/knada-airflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    KNADA Airflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/airflow/managed-airflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google managed Airflow (Cloud Composer)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Knast
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            Knast
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/knast/generelt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hva er Knast?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/knast/kom-i-gang/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Komme i gang
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/knast/miljo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Oppsett av miljø
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/knast/nettverk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nettverk
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/metabase/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metabase
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/datafortellinger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Datafortellinger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/koble-pseudonymiserte/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Koble sammen pseudonymiserte tabeller
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/allowlisting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Allowlisting av trafikk
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/google-secret-manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Secret Manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../analyse/eksempler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kodeeksempler
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Vår visjon
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Vår visjon
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../visjon/brukerforventninger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Brukerforventinger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../visjon/data_mesh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data mesh
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#flytte-data-fra-postgres-til-bigquery" class="md-nav__link">
    <span class="md-ellipsis">
      Flytte data fra Postgres til BigQuery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flytte data fra Postgres til BigQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#datastream" class="md-nav__link">
    <span class="md-ellipsis">
      Datastream
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Datastream">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hjelp-til-oppsett-av-datastream" class="md-nav__link">
    <span class="md-ellipsis">
      Hjelp til oppsett av Datastream
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#federated-query" class="md-nav__link">
    <span class="md-ellipsis">
      Federated query
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Federated query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kjre-sprring-pa-tidsintervall" class="md-nav__link">
    <span class="md-ellipsis">
      Kjøre spørring på tidsintervall
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flytte-data-fra-kafka-til-bigquery" class="md-nav__link">
    <span class="md-ellipsis">
      Flytte data fra Kafka til BigQuery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flytte data fra Kafka til BigQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kodeeksempler" class="md-nav__link">
    <span class="md-ellipsis">
      Kodeeksempler
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#naisjob" class="md-nav__link">
    <span class="md-ellipsis">
      Naisjob
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Naisjob">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bruksomrade" class="md-nav__link">
    <span class="md-ellipsis">
      Bruksområde
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Laste data fra kilde til BigQuery</h1>

<h2 id="flytte-data-fra-postgres-til-bigquery">Flytte data fra Postgres til BigQuery<a class="headerlink" href="#flytte-data-fra-postgres-til-bigquery" title="Permanent link">&para;</a></h2>
<h3 id="datastream">Datastream<a class="headerlink" href="#datastream" title="Permanent link">&para;</a></h3>
<p>Google tilbyr Datastream for å strømme data fra f.eks. Postgres til BigQuery.
Dataen strømmes til en samling (<code>dataset</code>) i BigQuery hvor kun teamet har tilgang.
Fra samlingen kan man gjøre transformasjoner og gjøre tabeller/view klare for bruk internt i teamet.
Tabeller/view kan også tilgjengeliggjøres for andre.</p>
<div class="admonition info">
<p class="admonition-title">Vi anbefaler at <code>diskAutoresize</code> for Postgres-databasen settes til <code>true</code> siden Datastream bruker en del lagringsplass.</p>
</div>
<h4 id="hjelp-til-oppsett-av-datastream">Hjelp til oppsett av Datastream<a class="headerlink" href="#hjelp-til-oppsett-av-datastream" title="Permanent link">&para;</a></h4>
<p>Det er laget to løsninger i Nav for å forenkle oppsett av dette. Vi anbefaler bruk av terraform-modulen.</p>
<p><a href="https://github.com/navikt/terraform-google-bigquery-datastream">Link til terraform-modul</a></p>
<p><a href="https://github.com/navikt/nada-datastream">Link til cli</a></p>
<pre class="mermaid"><code>flowchart LR
    A[(Postgres 1)] --&gt; C(Datastream)
    B[(Postgres 2)] --&gt; C

    C --&gt; D
    C --&gt; E
    D --transformasjon--&gt; F
    E --transformasjon--&gt; G


    subgraph BigQuery
       D[(Tabell 1)]
       E[(Tabell 2)]

       F[(Dataprodukt 1)]
       G[(Dataprodukt 2)]
    end</code></pre>
<h3 id="federated-query">Federated query<a class="headerlink" href="#federated-query" title="Permanent link">&para;</a></h3>
<p>Federated query brukes typisk til å lese data fra en postgres-database i GCP, transformere disse og skrive til BigQuery.</p>
<pre class="mermaid"><code>graph TD
postgres[(Postgres)] --Spørring mot Postgres-database i GCP--&gt; federated_query[Federated query]
federated_query --Ytterligere transformasjoner kan gjøres i BigQuery--&gt; BQ_query[BQ-query]
Schedule --Regelbasert styring av kjøringen--&gt; BQ_query
BQ_query --Tabell skrives til BigQuery--&gt; BigQuery[(BigQuery-tabell)]</code></pre>
<p>For å sette opp federated query:</p>
<ol>
<li><a href="https://cloud.google.com/bigquery/docs/cloud-sql-federated-queries#setting-up-cloud-sql-database-connections">Følg Google sin guide for å sette opp Cloud SQL databasetilkobling</a></li>
<li>
<p>Gi generert service account roller for å kunne utføre external queries</p>
<ul>
<li>Når man i (1) aktiverer <code>BigQuery Connection API</code> blir det automatisk generert en service account på formatet <code>service-&lt;projectNumber&gt;@gcp-sa-bigqueryconnection.iam.gserviceaccount.com</code>. Denne må gis følgende roller i prosjektet:<ul>
<li><code>Bigquery Connection Admin</code></li>
<li><code>Cloud SQL Client</code></li>
</ul>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title"><code>projectNumber</code> over er prosjektnummeret, ikke prosjekt ID. Du finner prosjektnummer <a href="https://console.cloud.google.com/welcome">her</a>.</p>
</div>
</li>
<li>
<p><a href="https://cloud.google.com/bigquery/docs/datasets">Følg Google sin guide for å opprette et BigQuery dataset</a></p>
<ul>
<li>Merk at <em>dataset</em> i denne konteksten er noe annet enn <a href="../../dataprodukt/#hva-er-et-datasett">datasett i Datamarkedsplassen</a></li>
<li>Foreløpig kan vi ikke gjenbruke datasets som har blitt opprettet av en nais-applikasjon, da denne overstyrer tilgangene vi oppretter senere i denne guiden</li>
</ul>
</li>
<li><a href="https://cloud.google.com/iam/docs/creating-managing-service-accounts">Følg Google sin guide for å lage en Google servicebruker for å kjøre en skedulert federated query</a><ul>
<li>Gi serviceaccounten følgende tilganger på prosjektnivå:<ul>
<li><em>BigQuery Connection User</em></li>
<li><em>BigQuery Job User</em></li>
<li><em>BigQuery Metadata Viewer</em></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://cloud.google.com/bigquery/docs/dataset-access-controls">Følg Google sin guide for å gi tilganger til servicebrukeren på datasett</a><ul>
<li>Serviceaccounten trenger rollen <em>BigQuery Data Editor</em></li>
</ul>
</li>
</ol>
<p>Etter at servicebrukeren har tilgang til datasettet kan man sette opp en spørring som henter data via <em>external connection</em>.</p>
<p>Gjennom <a href="https://console.cloud.google.com">Google Cloud Console</a> kan man velge prosjektet som datasettet tilhører, gå inn på BigQuery og klikke "Compose New Query" til høyre.</p>
<p>Eksempelvis:
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">EXTERNAL_QUERY</span><span class="p">(</span>
<span class="s1">&#39;europe-north1.&lt;connection_name&gt;&#39;</span><span class="p">,</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="s1">-- Lag en variabel for versjonering </span>
<span class="s1">WITH constants (version) as (</span>
<span class="s1">    values (now())</span>
<span class="s1">)</span>

<span class="s1">-- Legg inn rader fra Postgres-tabellen med et felt for version-variablen vi definerte over.</span>
<span class="s1">SELECT </span>
<span class="s1">    id::text, </span>
<span class="s1">    name, </span>
<span class="s1">    &quot;group&quot;, </span>
<span class="s1">    pii, </span>
<span class="s1">    created, </span>
<span class="s1">    last_modified, </span>
<span class="s1">    &quot;type&quot;::text, </span>
<span class="s1">    version</span>
<span class="s1">FROM dataproducts, constants</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">);</span>
</code></pre></div></p>
<h4 id="kjre-sprring-pa-tidsintervall">Kjøre spørring på tidsintervall<a class="headerlink" href="#kjre-sprring-pa-tidsintervall" title="Permanent link">&para;</a></h4>
<p>For å kjøre en spørring på intervall, så kan du i Query Explorer i Cloud Console velge å definere en "Schedule".</p>
<p>For å få lov til å sette opp eller oppdatere en schedule må din personlige bruker ha noen rettigheter også. 
Disse er for det meste dekket av Bigquery Admin, men hvis du setter opp jobben med en servicebruker (anbefalt) må du også ha tilgang til denne, for eksempel via en midlertidig Service Account Admin.</p>
<p>Klikk "Schedule" og "Create new schedule"</p>
<ul>
<li>Name: et passende navn </li>
<li>Repeats: Det som passer produktet</li>
<li>Dataset name: datasettet som ble laget tidligere</li>
<li>Table name: navn på produkt-tabell</li>
<li>Advanced options:<ul>
<li>Service account: servicebrukeren som ble laget tidligere</li>
</ul>
</li>
</ul>
<h2 id="flytte-data-fra-kafka-til-bigquery">Flytte data fra Kafka til BigQuery<a class="headerlink" href="#flytte-data-fra-kafka-til-bigquery" title="Permanent link">&para;</a></h2>
<p>For å ta data fra en Kafka-strøm til BigQuery, trenger du å sette opp en applikasjon.
<a href="#kode-eksempler">Under</a> følger enkle eksempler på hvordan å lese fra Kafka og skrive til BigQuery i forskjellige programmeringsspråk. 
Alle eksemplene forutsetter at en på forhånd har laget datasettet BigQuery tabellen skal opprettes i og at man har tilgang til å skrive til/opprette tabeller i datasettet.
Opprettelsen av datasettet og tilgangene ordnes automatisk når appen deployes til GCP-clusterne til nais med <a href="https://doc.nais.io/nais-application/application/#kafka">nais.yaml</a>. </p>
<h3 id="kodeeksempler">Kodeeksempler<a class="headerlink" href="#kodeeksempler" title="Permanent link">&para;</a></h3>
<p>Eksemplene tar ikke hensyn til autentisering mot Kafka så det antas at man kan lese fra kafka topicet anonymt. For mer informasjon om oppsett av app og autentisering for Kafka i NAV, se <a href="https://doc.nais.io/persistence/kafka/how-to/access/">nais docs</a>.</p>
<div class="admonition info">
<p class="admonition-title">Topicet det leses fra i eksemplene har JSON schema og inneholder fire felter: et tekstfelt, et boolean felt, et numerisk felt og et timestamp.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Python</label><label for="__tabbed_1_2">Kotlin</label><label for="__tabbed_1_3">Go</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Avhengigheter:
<div class="highlight"><pre><span></span><code>pip install google-cloud-bigquery kafka-python
</code></pre></div>
Kode:
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">kafka</span><span class="w"> </span><span class="kn">import</span> <span class="n">KafkaConsumer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.cloud</span><span class="w"> </span><span class="kn">import</span> <span class="n">bigquery</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_kafka_consumer</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kafka_brokers</span><span class="p">:</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">KafkaConsumer</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">KafkaConsumer</span><span class="p">(</span>
        <span class="n">topic</span><span class="p">,</span>
        <span class="n">bootstrap_servers</span><span class="o">=</span><span class="n">kafka_brokers</span><span class="p">,</span>
        <span class="n">api_version</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">auto_offset_reset</span><span class="o">=</span><span class="s1">&#39;earliest&#39;</span><span class="p">,</span>
        <span class="n">enable_auto_commit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">value_deserializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_bq_table_if_not_exists</span><span class="p">(</span><span class="n">bq_client</span><span class="p">:</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Client</span><span class="p">,</span> <span class="n">project_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
    <span class="n">table_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="s2">&quot;stringValue&quot;</span><span class="p">,</span> <span class="s2">&quot;STRING&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;REQUIRED&quot;</span><span class="p">),</span>
        <span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="s2">&quot;booleanValue&quot;</span><span class="p">,</span> <span class="s2">&quot;BOOLEAN&quot;</span><span class="p">),</span>
        <span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="s2">&quot;numericValue&quot;</span><span class="p">,</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">),</span>
        <span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="s2">&quot;timestampValue&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table_uri</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">exists_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="s2">&quot;PROJECT&quot;</span> <span class="c1"># erstatt med prosjekt id</span>
    <span class="n">dataset_id</span> <span class="o">=</span> <span class="s2">&quot;DATASET&quot;</span> <span class="c1"># erstatt med dataset id</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;TABLE&quot;</span> <span class="c1"># erstatt med tabellnavn</span>
    <span class="n">bq_client</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
    <span class="n">table_id</span> <span class="o">=</span> <span class="n">create_bq_table_if_not_exists</span><span class="p">(</span><span class="n">bq_client</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>

    <span class="n">topic_name</span> <span class="o">=</span> <span class="s2">&quot;TOPIC&quot;</span> <span class="c1"># erstatt med topic navn</span>
    <span class="n">kafka_brokers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BROKER1&quot;</span><span class="p">]</span> <span class="c1"># erstatt med liste av brokere</span>
    <span class="n">consumer</span> <span class="o">=</span> <span class="n">create_kafka_consumer</span><span class="p">(</span><span class="n">topic_name</span><span class="p">,</span> <span class="n">kafka_brokers</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mesg</span> <span class="ow">in</span> <span class="n">consumer</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mesg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">bq_client</span><span class="o">.</span><span class="n">insert_rows_json</span><span class="p">(</span><span class="n">table_id</span><span class="p">,</span> <span class="p">[</span><span class="n">mesg</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">errors</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
</code></pre></div></p>
</div>
<div class="tabbed-block">
<p>Avhengigheter:
<div class="highlight"><pre><span></span><code>implementation(&quot;com.google.cloud:google-cloud-bigquery:2.22.0&quot;)
implementation(&quot;org.apache.kafka:kafka-clients:3.4.0&quot;)
</code></pre></div></p>
<p>Kode:
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.JsonNode</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.google.cloud.bigquery.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.time.Duration</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.util.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.ConsumerRecords</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.KafkaConsumer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.time.temporal.ChronoUnit</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">bigQueryClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigQueryClient</span><span class="p">()</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">tableId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bigQueryClient</span><span class="p">.</span><span class="na">getOrCreateBigQueryTable</span><span class="p">(</span><span class="s">&quot;TABLE&quot;</span><span class="w"> </span><span class="cm">/* erstatt med tabellnavn */</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">kafkaConsumer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createKafkaConsumer</span><span class="p">()</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">records</span><span class="p">:</span><span class="w"> </span><span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="kt">String?</span><span class="p">,</span><span class="w"> </span><span class="kt">String?</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kafkaConsumer</span><span class="p">.</span><span class="na">poll</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMillis</span><span class="p">(</span><span class="m">100</span><span class="p">))</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">storeRecordInBigQuery</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">bigQueryClient</span><span class="p">,</span><span class="w"> </span><span class="n">tableId</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">setupBigQueryClient</span><span class="p">():</span><span class="w"> </span><span class="n">BigQueryClient</span><span class="w"> </span><span class="p">{</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">bqClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigQueryClient</span><span class="p">(</span><span class="n">projectId</span><span class="p">,</span><span class="w"> </span><span class="n">datasetId</span><span class="p">)</span>
<span class="k">return</span><span class="w"> </span><span class="n">bqClient</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">createKafkaConsumer</span><span class="p">():</span><span class="w"> </span><span class="n">KafkaConsumer</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kt">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">topicName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;TOPIC&quot;</span><span class="w"> </span><span class="c1">// erstatt med navn på Kafka topic</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">kafkaBrokers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;BROKERS&quot;</span><span class="w"> </span><span class="c1">// erstatt med navn på brokers</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Properties</span><span class="p">()</span>
<span class="n">props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;bootstrap.servers&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">kafkaBrokers</span><span class="p">)</span>
<span class="n">props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;group.id&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mygroup&quot;</span><span class="p">)</span>
<span class="n">props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;auto.offset.reset&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;earliest&quot;</span><span class="p">)</span>
<span class="n">props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;key.deserializer&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="p">)</span>
<span class="n">props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;value.deserializer&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">consumer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KafkaConsumer</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kt">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
<span class="w">    </span><span class="n">consumer</span><span class="p">.</span><span class="na">subscribe</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">topicName</span><span class="p">))</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">consumer</span>
<span class="p">}</span>

<span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">storeRecordInBigQuery</span><span class="p">(</span><span class="n">record</span><span class="p">:</span><span class="w"> </span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="kt">String?</span><span class="w"> </span><span class="kt">String?</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">bigQueryClient</span><span class="p">:</span><span class="w"> </span><span class="n">BigQueryClient</span><span class="p">,</span><span class="w"> </span><span class="n">tableId</span><span class="p">:</span><span class="w"> </span><span class="kt">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span>
<span class="s">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="p">,</span>
<span class="n">record</span><span class="p">.</span><span class="na">offset</span><span class="p">(),</span>
<span class="n">record</span><span class="p">.</span><span class="na">key</span><span class="p">(),</span>
<span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">()</span>
<span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="p">().</span><span class="na">readValue</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">(),</span><span class="w"> </span><span class="n">JsonNode</span><span class="o">::</span><span class="n">class</span><span class="p">.</span><span class="na">java</span><span class="p">)</span>
<span class="n">bigQueryClient</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">tableId</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">BigQueryClient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">projectId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PROJECT&quot;</span><span class="w"> </span><span class="c1">// erstatt med prosjektets id</span>
<span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">datasetId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;DATASET&quot;</span><span class="w"> </span><span class="c1">// erstatt med datasett id</span>
<span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">bigQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigQueryOptions</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
<span class="p">.</span><span class="na">setProjectId</span><span class="p">(</span><span class="n">projectId</span><span class="p">)</span>
<span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="p">.</span><span class="na">service</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getOrCreateTable</span><span class="p">(</span><span class="n">tableName</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">):</span><span class="w"> </span><span class="n">TableId</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">tableId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TableId</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">datasetId</span><span class="p">,</span><span class="w"> </span><span class="n">tableName</span><span class="p">)</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bigQuery</span><span class="p">.</span><span class="na">getTable</span><span class="p">(</span><span class="n">tableId</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">table</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">table</span><span class="p">.</span><span class="na">tableId</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">createTable</span><span class="p">(</span><span class="n">tableName</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">createTable</span><span class="p">(</span><span class="n">tableName</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">):</span><span class="w"> </span><span class="n">TableId</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Schema</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<span class="w">            </span><span class="n">Field</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">(</span><span class="s">&quot;stringValue&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StandardSQLTypeName</span><span class="p">.</span><span class="na">STRING</span><span class="p">).</span><span class="na">setMode</span><span class="p">(</span><span class="n">Field</span><span class="p">.</span><span class="na">Mode</span><span class="p">.</span><span class="na">REQUIRED</span><span class="p">).</span><span class="na">build</span><span class="p">(),</span>
<span class="w">            </span><span class="n">Field</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;booleanValue&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StandardSQLTypeName</span><span class="p">.</span><span class="na">BOOL</span><span class="p">),</span>
<span class="w">            </span><span class="n">Field</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;numericValue&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StandardSQLTypeName</span><span class="p">.</span><span class="na">INT64</span><span class="p">),</span>
<span class="w">            </span><span class="n">Field</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;timestampValue&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StandardSQLTypeName</span><span class="p">.</span><span class="na">TIMESTAMP</span><span class="p">),</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">tableId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TableId</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">datasetId</span><span class="p">,</span><span class="w"> </span><span class="n">tableName</span><span class="p">)</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">tableDefinition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StandardTableDefinition</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">tableInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TableInfo</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">(</span><span class="n">tableId</span><span class="p">,</span><span class="w"> </span><span class="n">tableDefinition</span><span class="p">).</span><span class="na">build</span><span class="p">()</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bigQuery</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">tableInfo</span><span class="p">).</span><span class="na">tableId</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="n">tableId</span><span class="p">:</span><span class="w"> </span><span class="n">TableId</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="n">JsonNode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InsertAllRequest</span><span class="p">.</span><span class="na">RowToInsert</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">mapOf</span><span class="p">(</span>
<span class="w">            </span><span class="n">value</span><span class="p">.</span><span class="na">use</span><span class="p">(</span><span class="s">&quot;stringValue&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">textValue</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="n">value</span><span class="p">.</span><span class="na">use</span><span class="p">(</span><span class="s">&quot;booleanValue&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">booleanValue</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="n">value</span><span class="p">.</span><span class="na">use</span><span class="p">(</span><span class="s">&quot;numericValue&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">intValue</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="n">value</span><span class="p">.</span><span class="na">use</span><span class="p">(</span><span class="s">&quot;timestampValue&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="n">asText</span><span class="p">()).</span><span class="na">truncatedTo</span><span class="p">(</span><span class="n">ChronoUnit</span><span class="p">.</span><span class="na">MICROS</span><span class="p">).</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">))</span>

<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bigQuery</span><span class="p">.</span><span class="na">getTable</span><span class="p">(</span><span class="n">tableId</span><span class="p">)</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">listOf</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">response</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;Lagring i BigQuery feilet: &#39;</span><span class="si">${</span><span class="n">response</span><span class="p">.</span><span class="na">insertErrors</span><span class="si">}</span><span class="s">&#39;&quot;</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">JsonNode</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">transform</span><span class="p">:</span><span class="w"> </span><span class="n">JsonNode</span><span class="p">.()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">T</span><span class="p">):</span><span class="w"> </span><span class="n">Pair</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">T?&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span>
<span class="n">transform</span><span class="p">(</span><span class="nb">it</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></p>
</div>
<div class="tabbed-block">
<p>Avhengigheter:
<div class="highlight"><pre><span></span><code>go get &quot;cloud.google.com/go/bigquery&quot;
go get &quot;github.com/confluentinc/confluent-kafka-go/kafka&quot;
go get &quot;google.golang.org/api/googleapi&quot;
</code></pre></div></p>
<p>Kode:
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;context&quot;</span>
<span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>

<span class="w">    </span><span class="s">&quot;cloud.google.com/go/bigquery&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/confluentinc/confluent-kafka-go/kafka&quot;</span>
<span class="w">    </span><span class="s">&quot;golang.org/x/xerrors&quot;</span>
<span class="w">    </span><span class="s">&quot;google.golang.org/api/googleapi&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">mesg</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">StringValue</span><span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;stringValue&quot;`</span>
<span class="w">    </span><span class="nx">BooleanValue</span><span class="w">   </span><span class="kt">bool</span><span class="w">   </span><span class="s">`json:&quot;booleanValue&quot;`</span>
<span class="w">    </span><span class="nx">NumericValue</span><span class="w">   </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;numericValue&quot;`</span>
<span class="w">    </span><span class="nx">TimestampValue</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;timestampValue&quot;`</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">kafkaBroker</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;BROKER&quot;</span><span class="w"> </span><span class="c1">// erstatt med kafka broker</span>
<span class="w">    </span><span class="nx">topicName</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;TOPIC&quot;</span><span class="w"> </span><span class="c1">// erstatt med navn på topic</span>

<span class="w">    </span><span class="nx">projectID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;PROJECT&quot;</span><span class="w"> </span><span class="c1">// erstatt med prosjekt id</span>
<span class="w">    </span><span class="nx">datasetID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;DATASET&quot;</span><span class="w"> </span><span class="c1">// erstatt med dataset id</span>
<span class="w">    </span><span class="nx">tableName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;TABLE&quot;</span><span class="w"> </span><span class="c1">// erstatt med navn på tabell</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">()</span>
<span class="w">    </span><span class="nx">consumer</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createKafkaConsumer</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">consumer</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">    </span><span class="nx">bqClient</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bigquery</span><span class="p">.</span><span class="nx">NewClient</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">projectID</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">bqClient</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">    </span><span class="nx">table</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createTableIfNotExists</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">bqClient</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">inserter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">table</span><span class="p">.</span><span class="nx">Inserter</span><span class="p">()</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">event</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">consumer</span><span class="p">.</span><span class="nx">Poll</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">event</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">*</span><span class="nx">kafka</span><span class="p">.</span><span class="nx">Message</span><span class="p">:</span>
<span class="w">            </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mesg</span><span class="p">{}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">data</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">inserter</span><span class="p">.</span><span class="nx">Put</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">kafka</span><span class="p">.</span><span class="nx">Error</span><span class="p">:</span>
<span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%% Error: %v\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">)</span>
<span class="w">        </span><span class="k">default</span><span class="p">:</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">createKafkaConsumer</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">kafka</span><span class="p">.</span><span class="nx">Consumer</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">consumer</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">kafka</span><span class="p">.</span><span class="nx">NewConsumer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">kafka</span><span class="p">.</span><span class="nx">ConfigMap</span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;bootstrap.servers&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">kafkaBroker</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;group.id&quot;</span><span class="p">:</span><span class="w">          </span><span class="s">&quot;mygroup&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;auto.offset.reset&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;earliest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">consumer</span><span class="p">.</span><span class="nx">SubscribeTopics</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="nx">topicName</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">consumer</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">createTableIfNotExists</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">bqClient</span><span class="w"> </span><span class="o">*</span><span class="nx">bigquery</span><span class="p">.</span><span class="nx">Client</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">bigquery</span><span class="p">.</span><span class="nx">Table</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bigquery</span><span class="p">.</span><span class="nx">Schema</span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;stringValue&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="nx">bigquery</span><span class="p">.</span><span class="nx">StringFieldType</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;booleanValue&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="nx">bigquery</span><span class="p">.</span><span class="nx">BooleanFieldType</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;numericValue&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="nx">bigquery</span><span class="p">.</span><span class="nx">IntegerFieldType</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;timestampValue&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="nx">bigquery</span><span class="p">.</span><span class="nx">TimestampFieldType</span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">metadata</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">bigquery</span><span class="p">.</span><span class="nx">TableMetadata</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Schema</span><span class="p">:</span><span class="w"> </span><span class="nx">schema</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">tableRef</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bqClient</span><span class="p">.</span><span class="nx">Dataset</span><span class="p">(</span><span class="nx">datasetID</span><span class="p">).</span><span class="nx">Table</span><span class="p">(</span><span class="nx">tableName</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tableRef</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">googleapi</span><span class="p">.</span><span class="nx">Error</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">xerrors</span><span class="p">.</span><span class="nx">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">e</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">409</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// already exists</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">tableRef</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">tableRef</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div></p>
</div>
</div>
</div>
<h2 id="naisjob">Naisjob<a class="headerlink" href="#naisjob" title="Permanent link">&para;</a></h2>
<p>NAIS-plattformen tilbyr skedulering av workloads med deres <a href="https://doc.nais.io/naisjob">naisjob-ressurs</a>.</p>
<p>Denne ressurstypen er en abstraksjon på Kubernetes sin <a href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/">Cronjob</a> som gir deg de samme konfigurasjonsmulighetene som man får med NAIS applikasjoner, eksempelvis muligheten til å provisjonere buckets, postgres/BigQuery og kafka-brukere, samt injeksjon av hemmeligheter i kjøremiljøet til jobben ved runtime.</p>
<h3 id="bruksomrade">Bruksområde<a class="headerlink" href="#bruksomrade" title="Permanent link">&para;</a></h3>
<p>Naisjob egner seg godt dersom du trenger å skedulere kjøring av kode, f.eks. periodisk oppdatering av <a href="../../dataprodukt/">dataprodukter</a> eller <a href="../../../analyse/datafortellinger/">datafortellinger</a>.</p>









  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Fikk du svar på det du lurte på?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="Nei" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="Ja" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Takk! Kontakt oss gjerne på <a href="https://nav-it.slack.com/archives/CGRMQHT50">#nada på Slack</a> med tilbakemeldinger eller spørsmål.
            </div>
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Takk for tilbakemeldingen!
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.sections", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>