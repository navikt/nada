"use strict";(self.webpackChunknada=self.webpackChunknada||[]).push([[202],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return u}});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=o.createContext({}),p=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(n),u=r,k=d["".concat(l,".").concat(u)]||d[u]||m[u]||a;return n?o.createElement(k,i(i({ref:t},c),{},{components:n})):o.createElement(k,i({ref:t},c))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<a;p++)i[p]=n[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6807:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return c},default:function(){return d}});var o=n(7462),r=n(3366),a=(n(7294),n(3905)),i=["components"],s={title:"Cloud Composer"},l=void 0,p={unversionedId:"prosessere-data/cloud-composer",id:"prosessere-data/cloud-composer",isDocsHomePage:!1,title:"Cloud Composer",description:"Cloud Composer is a managed Apache Airflow service that helps you create, schedule,",source:"@site/docs/prosessere-data/cloud-composer.md",sourceDirName:"prosessere-data",slug:"/prosessere-data/cloud-composer",permalink:"/prosessere-data/cloud-composer",editUrl:"https://github.com/navikt/nada/edit/master/docs/prosessere-data/cloud-composer.md",tags:[],version:"current",frontMatter:{title:"Cloud Composer"},sidebar:"docs",previous:{title:"Kom i gang",permalink:"/prosessere-data/getting-started"},next:{title:"Naisjobs",permalink:"/prosessere-data/naisjobs"}},c=[{value:"Opprett ny composer instans",id:"opprett-ny-composer-instans",children:[]},{value:"Oppsett av github repo for DAGS",id:"oppsett-av-github-repo-for-dags",children:[{value:"Lag service account",id:"lag-service-account",children:[]},{value:"Last ned service account n\xf8kkel",id:"last-ned-service-account-n\xf8kkel",children:[]},{value:"Lag repo",id:"lag-repo",children:[]},{value:"Oppsett av repo",id:"oppsett-av-repo",children:[]}]},{value:"Legg til DAGs",id:"legg-til-dags",children:[]},{value:"Synkronisere requirements.txt i repo mot cloud composer milj\xf8",id:"synkronisere-requirementstxt-i-repo-mot-cloud-composer-milj\xf8",children:[]}],m={toc:c};function d(e){var t=e.components,n=(0,r.Z)(e,i);return(0,a.kt)("wrapper",(0,o.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Cloud Composer is a managed Apache Airflow service that helps you create, schedule,\nmonitor and manage workflows. Cloud Composer automation helps you create Airflow environments quickly and use\nAirflow-native tools, such as the powerful Airflow web interface and command line tools, so you can focus on your\nworkflows and not your infrastructure.")),(0,a.kt)("p",null,"Du finner den offisielle dokumentasjonen for Cloud Composer hos ",(0,a.kt)("a",{parentName:"p",href:"https://cloud.google.com/composer/docs/konsepter/overview"},"cloud.google.com"),"."),(0,a.kt)("h2",{id:"opprett-ny-composer-instans"},"Opprett ny composer instans"),(0,a.kt)("p",null,"For \xe5 sette opp en ny Cloud Composer instans gjennom Google Cloud Platform konsollen (GCP),\ng\xe5r du f\xf8rst til ",(0,a.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/composer"},"Cloud Composer")," og trykker ",(0,a.kt)("inlineCode",{parentName:"p"},"CREATE")),(0,a.kt)("p",null,"F\xf8lgende m\xe5 spesifiseres"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"Name")," - navn p\xe5 Cloud Composer instansen"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"Location")," - regionen hvor instansen settes opp (m\xe5 velge Europa)"),(0,a.kt)("li",{parentName:"ol"},"Trykk ",(0,a.kt)("inlineCode",{parentName:"li"},"CREATE"))),(0,a.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"N\xe5r man setter opp Cloud Composer s\xe5 opprettes det automatisk en ",(0,a.kt)("a",{parentName:"p",href:"https://cloud.google.com/storage/docs/introduction"},"bucket"),"\nsom er knyttet til Composer instansen.\nF\xf8r neste steg er det viktig \xe5 notere seg navnet p\xe5 bucketen som blir opprettet. Det gj\xf8res ved \xe5 g\xe5 til\n",(0,a.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/storage"},"Cloud Storage")," i konsollen og finne bucketen som har ",(0,a.kt)("inlineCode",{parentName:"p"},"goog-composer-environment")," labels."))),(0,a.kt)("h2",{id:"oppsett-av-github-repo-for-dags"},"Oppsett av github repo for DAGS"),(0,a.kt)("p",null,"I bucketen som opprettes n\xe5r man setter opp Cloud Composer i ",(0,a.kt)("a",{parentName:"p",href:"cloud-composer#opprett-ny-composer-instans"},"Opprett ny composer instans"),"\nblir det automatisk laget en mappe som heter ",(0,a.kt)("inlineCode",{parentName:"p"},"dags"),". Denne mappen inneholder beskrivelsene av datapipelinene (DAGs) som man kan\norkestrere med Cloud Composer og dette synkroniseres kontinuerlig med instansen."),(0,a.kt)("p",null,"For \xe5 ha revisjonskontroll p\xe5 disse pipelinebeskrivelsene l\xf8nner det seg \xe5 sette opp en synkronisering mot et github repo. Under\nf\xf8lger en oppskrift for dette."),(0,a.kt)("h3",{id:"lag-service-account"},"Lag service account"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"G\xe5 til ",(0,a.kt)("a",{parentName:"li",href:"https://console.cloud.google.com/iam-admin/serviceaccounts"},"Google IAM"),"\nog trykk p\xe5 ",(0,a.kt)("inlineCode",{parentName:"li"},"CREATE SERVICE ACCOUNT")),(0,a.kt)("li",{parentName:"ol"},"Fyll in ",(0,a.kt)("inlineCode",{parentName:"li"},"Service account name")," og en ",(0,a.kt)("inlineCode",{parentName:"li"},"Service account description")),(0,a.kt)("li",{parentName:"ol"},"Gi service accounten f\xf8lgende rettigheter til bucketen opprettet i ",(0,a.kt)("a",{parentName:"li",href:"cloud-composer#opprett-ny-composer-instans"},"Opprett ny composer instans"),":",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Storage Legacy Bucket Writer")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Storage Object Admin"))))),(0,a.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"Merk deg eposten som den nyopprettede service accounten f\xe5r"))),(0,a.kt)("h3",{id:"last-ned-service-account-n\xf8kkel"},"Last ned service account n\xf8kkel"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"G\xe5 til ",(0,a.kt)("a",{parentName:"li",href:"https://console.cloud.google.com/iam-admin/serviceaccounts"},"Google IAM")),(0,a.kt)("li",{parentName:"ol"},"Trykk p\xe5 service accounten opprettet i ",(0,a.kt)("a",{parentName:"li",href:"cloud-composer#lag-service-account"},"Lag service account")),(0,a.kt)("li",{parentName:"ol"},"Trykk p\xe5 ",(0,a.kt)("inlineCode",{parentName:"li"},"KEYS")),(0,a.kt)("li",{parentName:"ol"},"Trykk ",(0,a.kt)("inlineCode",{parentName:"li"},"ADD KEY")," -> ",(0,a.kt)("inlineCode",{parentName:"li"},"Create new key")," -> ",(0,a.kt)("inlineCode",{parentName:"li"},"JSON")),(0,a.kt)("li",{parentName:"ol"},"Ta vare p\xe5 n\xf8kkelen som blir lastet ned")),(0,a.kt)("h3",{id:"lag-repo"},"Lag repo"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Opprett github repo under navikt-organisasjonen"),(0,a.kt)("li",{parentName:"ol"},"Opprett f\xf8lgende to secrets i github repoet:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Name")," satt til GCS_CREDS og ",(0,a.kt)("inlineCode",{parentName:"li"},"Value")," til innholdet i JSON-n\xf8kkelen lastet ned i ",(0,a.kt)("a",{parentName:"li",href:"cloud-composer#last-ned-service-account-n%C3%B8kkel"},"Last ned service account n\xf8kkel")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Name")," satt til PROJECT_ID og ",(0,a.kt)("inlineCode",{parentName:"li"},"Value")," til GCP prosjektets id (finnes ",(0,a.kt)("a",{parentName:"li",href:"https://console.cloud.google.com/home/dashboard"},"her"),")")))),(0,a.kt)("h3",{id:"oppsett-av-repo"},"Oppsett av repo"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Lag en mappe med navn ",(0,a.kt)("inlineCode",{parentName:"li"},"dags")," i repoet"),(0,a.kt)("li",{parentName:"ol"},"Lag filen .github/workflows/sync-gcs-bucket.yaml med innhold som f\xf8lger")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"name: Sync-GCS-bucket\n\non:\n  push:\n    branches:\n      - main\n    paths:\n      - '.github/workflows/sync-gcs.yaml'\n      - 'dags/**'\n\njobs:\n  sync-gcs-bucket:\n    runs-on: ubuntu-latest\n    steps:\n    - uses: actions/checkout@v2\n    - uses: GoogleCloudPlatform/github-actions/setup-gcloud@master\n      with:\n        service_account_key: ${{ secrets.GCS_CREDS }}\n        project_id: ${{ secrets.PROJECT_ID }}\n        export_default_credentials: true\n    - name: Sync dags to gcs bucket\n      run: gsutil cp -r dags gs://BUCKET\n")),(0,a.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"Erstatt BUCKET i workflowen over med navnet p\xe5 bucketen som ble opprettet i\n",(0,a.kt)("a",{parentName:"p",href:"cloud-composer#opprett-ny-composer-instans"},"Opprett ny composer instans")))),(0,a.kt)("p",null,"Ved push til main branch vil denne workflowen laste opp innholdet i ",(0,a.kt)("inlineCode",{parentName:"p"},"dags")," mappen i repoet til gcs bucketen\nsom igjen synkroniseres med Cloud Composer instansen."),(0,a.kt)("h2",{id:"legg-til-dags"},"Legg til DAGs"),(0,a.kt)("p",null,"N\xe5 er man klar til \xe5 begynne \xe5 legge til DAGs. Eksempler p\xe5 dags finnes i repoet\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/navikt/composer-dags"},"navikt/composer-dags")),(0,a.kt)("h2",{id:"synkronisere-requirementstxt-i-repo-mot-cloud-composer-milj\xf8"},"Synkronisere requirements.txt i repo mot cloud composer milj\xf8"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Legg en ",(0,a.kt)("inlineCode",{parentName:"li"},"requirements.txt")," fil i repoet"),(0,a.kt)("li",{parentName:"ol"},"Lag filen ",(0,a.kt)("inlineCode",{parentName:"li"},".github/workflows/update-requirements.yaml")," med innhold som f\xf8lger")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"name: Update-composer-dependencies\n\non:\n  push:\n    branches:\n      - main\n    paths:\n      - 'requirements.txt'\n      - '.github/workflows/update-requirements.yaml'\n\njobs:\n  update-composer-requirements:\n    runs-on: ubuntu-latest\n    steps:\n    - uses: actions/checkout@v2\n    - uses: GoogleCloudPlatform/github-actions/setup-gcloud@master\n      with:\n        service_account_key: ${{ secrets.GCS_CREDS }}\n        project_id: ${{ secrets.PROJECT_NAME }}\n        export_default_credentials: true\n    - name: Update requirements.txt\n      continue-on-error: true\n      run: |\n        gcloud composer environments update COMPOSER_INSTANS --update-pypi-packages-from-file requirements.txt --location LOCATION --project ${GCLOUD_PROJECT}\n")),(0,a.kt)("p",null,"Erstatt ",(0,a.kt)("inlineCode",{parentName:"p"},"COMPOSER_INSTANS")," med navnet p\xe5 composer instansen din og ",(0,a.kt)("inlineCode",{parentName:"p"},"LOCATION")," med\nnavnet p\xe5 lokasjonen composeren kj\xf8rer. Begge disse verdiene finner du\n",(0,a.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/composer/environments"},"her"),"."))}d.isMDXComponent=!0}}]);