"use strict";(self.webpackChunknada=self.webpackChunknada||[]).push([[408],{3905:function(e,t,a){a.d(t,{Zo:function(){return m},kt:function(){return g}});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},s=Object.keys(e);for(r=0;r<s.length;r++)a=s[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)a=s[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var i=r.createContext({}),p=function(e){var t=r.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},m=function(e){var t=p(e.components);return r.createElement(i.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,s=e.originalType,i=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),u=p(a),g=n,k=u["".concat(i,".").concat(g)]||u[g]||d[g]||s;return a?r.createElement(k,o(o({ref:t},m),{},{components:a})):r.createElement(k,o({ref:t},m))}));function g(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var s=a.length,o=new Array(s);o[0]=u;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l.mdxType="string"==typeof e?e:n,o[1]=l;for(var p=2;p<s;p++)o[p]=a[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}u.displayName="MDXCreateElement"},781:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return l},contentTitle:function(){return i},metadata:function(){return p},toc:function(){return m},default:function(){return u}});var r=a(7462),n=a(3366),s=(a(7294),a(3905)),o=["components"],l={title:"Postgres"},i=void 0,p={unversionedId:"prosessere-data/onprem/dataverk/settings/postgres",id:"prosessere-data/onprem/dataverk/settings/postgres",isDocsHomePage:!1,title:"Postgres",description:"Postgres tilkoblinger fra kubeflow",source:"@site/docs/prosessere-data/onprem/dataverk/settings/postgres.md",sourceDirName:"prosessere-data/onprem/dataverk/settings",slug:"/prosessere-data/onprem/dataverk/settings/postgres",permalink:"/prosessere-data/onprem/dataverk/settings/postgres",editUrl:"https://github.com/navikt/nada/edit/master/docs/prosessere-data/onprem/dataverk/settings/postgres.md",tags:[],version:"current",frontMatter:{title:"Postgres"},sidebar:"docs",previous:{title:"Settingsfil",permalink:"/prosessere-data/onprem/dataverk/settings/README"},next:{title:"Sletting av datapakker",permalink:"/prosessere-data/onprem/dataverk/slette-datapakker"}},m=[{value:"Postgres tilkoblinger fra kubeflow",id:"postgres-tilkoblinger-fra-kubeflow",children:[]}],d={toc:m};function u(e){var t=e.components,a=(0,n.Z)(e,o);return(0,s.kt)("wrapper",(0,r.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h2",{id:"postgres-tilkoblinger-fra-kubeflow"},"Postgres tilkoblinger fra kubeflow"),(0,s.kt)("p",null,"Tilkobling til postgres databaser fra kubeflow krever noe mer oppsett enn \xf8vrige databasetilkoblinger.\n\xc5rsaken til dette er at postgres credentials har TTL p\xe5 24 timer og man trenger periodisk\n\xe5 hente nye credentials fra vault etter denne tidsperioden."),(0,s.kt)("p",null,"F\xf8lges oppskriften under vil dataverk h\xe5ndtere fornying av credentials automatisk ved \xe5 hente nye\nvia http apiet til vault n\xe5r de gamle blir ugyldig."),(0,s.kt)("h4",{id:"1-sett-opp-tilganger-for-kubeflow-namespace"},"1. Sett opp tilganger for kubeflow namespace"),(0,s.kt)("p",null,"Avhengig av om man jobber fra et personlig eller et team namespace i kubeflow f\xe5r man tilgang til postgres\ndatabaser ved \xe5 opprette en pull request i ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/navikt/vault-iac"},"navikt/vault-iac"),"."),(0,s.kt)("p",null,"Merk: Etter at pull requesten er godkjent og merget inn vil det ta 5-10 minutter f\xf8r endringene i vault\ner synkronisert."),(0,s.kt)("h5",{id:"tilgang-personlig-bruker"},"Tilgang personlig bruker"),(0,s.kt)("p",null,"For \xe5 f\xe5 tilgang til en postgres database fra et personlig kubeflow namespace m\xe5 man opprette eller\neditere en bruker ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/navikt/vault-iac/tree/master/terraform/users"},"her"),"."),(0,s.kt)("p",null,"F.eks."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"email: ola.nordmann@nav.no\nkubeflow:\n  - namespace: ola-nordmann\npostgresql:\n  dev-fss:\n    - database_name: <databasenavn_dev>\n      permission_level: <rolle>\n  prod-fss:\n    - database_name: <databasenavn_prod>\n      permission_level: <rolle>\n")),(0,s.kt)("p",null,"I eksempelet over er ",(0,s.kt)("em",{parentName:"p"},"database_name")," navnet p\xe5 databasen du \xf8nsker tilgang til. Dette finner man i\n",(0,s.kt)("a",{parentName:"p",href:"https://github.com/navikt/database-iac"},"navikt/database-iac"),". ",(0,s.kt)("em",{parentName:"p"},"Rolle")," vil v\xe6re rollen (",(0,s.kt)("a",{parentName:"p",href:"https://github.com/navikt/database-iac/blob/master/README.md"},"admin, user eller readonly"),") som brukeren som provisjoneres skal ha."),(0,s.kt)("h5",{id:"tilgang-team"},"Tilgang team"),(0,s.kt)("p",null,"For \xe5 f\xe5 tilgang til en postgres database fra et team namespace i kubeflow m\xe5 man opprette eller\neditere teamtilgang ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/navikt/vault-iac/tree/master/terraform/teams"},"her"),"."),(0,s.kt)("p",null,"F.eks."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"name: mitt-team\ngroup_id: <gruppe-id>\npostgresql:\n  dev-fss:\n    - database_name: <databasenavn>\n      permission_level: <rolle>\nkubeflow:\n  - namespace: <namespace>\n    extra_policies:\n      - postgresql_preprod-fss_<databasenavn>_<rolle>\n")),(0,s.kt)("p",null,"I eksempelet over vil ",(0,s.kt)("em",{parentName:"p"},"gruppe-id")," v\xe6re IDen til\n",(0,s.kt)("a",{parentName:"p",href:"https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/GroupsManagementMenuBlade/AllGroups"},"AAD gruppen"),",\n",(0,s.kt)("em",{parentName:"p"},"databasenavn")," navnet p\xe5 ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/navikt/database-iac"},"databasen"),"\ndu \xf8nsker tilgang til, ",(0,s.kt)("em",{parentName:"p"},"namespace")," navnet p\xe5 kubeflow namespacet og ",(0,s.kt)("em",{parentName:"p"},"rolle")," v\xe6re rollen (",(0,s.kt)("a",{parentName:"p",href:"https://github.com/navikt/database-iac/blob/master/README.md"},"admin, user eller readonly"),") som brukeren som provisjoneres skal ha. NB! ",(0,s.kt)("em",{parentName:"p"},"rolle")," m\xe5 matche permission_level som er spesifisert for teamet."),(0,s.kt)("h4",{id:"2-legg-til-connection-string-i-vault"},"2. Legg til connection string i vault"),(0,s.kt)("p",null,"I vault legges connection string til databasen inn som key/value par under stien\ntil kubeflow namespacet som beskrevet ",(0,s.kt)("a",{parentName:"p",href:"/prosessere-data/onprem/dataverk/settings/README"},"her"),"."),(0,s.kt)("p",null,"F.eks."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'POSTGRES_CREDENTIALS: "postgres://user:pass@<hostname>:<port>/<database>"\nPOSTGRES_CREDS_PATH: "postgresql/preprod-fss/creds/<database>-<rolle>"\n')),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"Host"),", ",(0,s.kt)("em",{parentName:"p"},"port")," og ",(0,s.kt)("em",{parentName:"p"},"database")," over finner man i\n",(0,s.kt)("a",{parentName:"p",href:"https://github.com/navikt/database-iac"},"navikt/database-iac"),"."),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"Rolle")," v\xe6re rollen (",(0,s.kt)("a",{parentName:"p",href:"https://github.com/navikt/database-iac/blob/master/README.md"},"admin, user eller readonly"),") som brukeren som provisjoneres skal ha."),(0,s.kt)("p",null,"Merk: Autentiseringsdelen av connection strengen (",(0,s.kt)("em",{parentName:"p"},"user:pass")," over) m\xe5 v\xe6re med. Det spiller ingen rolle\nhva man setter dette til da dataverk vil bytte det ut med gyldige credentials n\xe5r man fors\xf8ker \xe5 gj\xf8re\nen sp\xf8rring, men det m\xe5 st\xe5 en verdi her som default."),(0,s.kt)("h4",{id:"3-settingsfil"},"3. Settingsfil"),(0,s.kt)("p",null,"Som med andre secrets (beskrevet ",(0,s.kt)("a",{parentName:"p",href:"/prosessere-data/onprem/dataverk/settings/README"},"her"),") m\xe5 f\xf8lgende legges til i\nsetting.json filen dataverk benytter."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-python"},'{\n  "db_connection_strings": {\n    "postgres_database": "${POSTGRES_CREDENTIALS}"\n  },\n  \n  "db_vault_path": {\n    "postgres_database": "${POSTGRES_CREDS_PATH}"\n  }\n}\n')),(0,s.kt)("p",null,"${POSTGRES_CREDENTIALS} og ${POSTGRES_CREDS_PATH} vil s\xe5 erstattes med verdien i vault n\xe5r dataverk parser settings.json filen."),(0,s.kt)("h4",{id:"4-les-fra-postgres"},"4. Les fra postgres"),(0,s.kt)("p",null,"Etter at alt over er konfigurert kan man bruke dataverk til \xe5 lese fra postgres databasen p\xe5 samme m\xe5te som\nandre databaser, dvs.:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-python"},'from dataverk import Client\n\ndv = Client()\n\ndf = dv.read_sql("postgres_database", "SELECT * FROM table")\n')))}u.isMDXComponent=!0}}]);